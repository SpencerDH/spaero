---
title: "Getting Started with spaero"
author: "Eamon O'Dea"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
bibliography: ews.bib
vignette: >
  %\VignetteIndexEntry{Getting Started with spaero}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The spaero package (pronounced sparrow) currently supports the
estimation of statistics along rolling windows of time series. Such
estimates may in some cases provide signals that the system generating
the data is approaching a critical transition. Examples of critical
transitions include the eutrophication of lakes, changes in climate,
and emergence or eradication of infectious diseases. The spearo
package will be further developed to further support statistical
methods to predict critical transitions in infectious disease
systems. Because these methods will be based on generic properties of
dynamical systems, they have the potential to apply to a broad range
of models. The spaero package will also be developed to support
computational experiments designed to evaluate these methods. This
document provides a rudimentary demonstration of the application of
such methods on simulated data.

Our simulated data is a time series produced by a stochastic SIR
simulator included in the spaero package. See @keeling2008 for an
introduction to the SIR model. The simulator currently is capable of
including time dependent parameters. Gillespie's direct method is used
to update the model variables during the simulation. Transitions
between states occurs according to the rules given in
Table~\ref{trules}, which makes use of the symbols defined in
Table~\ref{tsymb}. Because some of the transition rates may change
continuously with time and because the simulation algorithm updates
the rates only at points of time when the model's state variables are
updated, these simulations are not in general exact. However, for many
realistic scenarios birth and death updates occur frequently enough
that the simulation should be highly accurate.

\begin{table}[h] \caption{Transition rules for our stochastic SIR
model} \label{trules}
\begin{tabular}{lll} \hline{Event}&{($\Delta S,\Delta I, \Delta R$)}&{Rate}\\
\hline birth of a susceptible & $(1,0,0)$ & $ \mu + \mu_t $\\
death of a susceptible & $(-1,0,0)$& $S (d + d_t)$\\
infection & $(-1,1,0)$ & $(\beta + \beta_t) I S + (\eta + \eta_t) S$\\
death of an infective & $(0,-1,0)$ & $I (d + d_t)$\\
recovery of an infective & $(0,-1,1)$ & $I (\gamma + \gamma_t)$\\
death of a removed & $(0,0,-1)$ & $R (d + d_t)$\\
\hline \end{tabular} \end{table}

\begin{table}[h] \caption{Model symbol definitions. Time-dependent rates have a $t$ subscript.}
\label{tsymb}
\begin{tabular}{lll}
\hline
{Symbol}&{Definition}\\
\hline
$\eta, \eta_t$ & rate of infection from outside of population (i.e., sparking rate) \\
$\beta, \beta_t$ & rates of transmission from within population contacts \\
$\mu, \mu_t$ & birth rates \\
$d, d_t$ & death rates \\
$S$ & number of susceptible individuals\\
$I$ & number of infective individuals \\
$R$ & number of removed individuals \\
$N$ & total population size, $S + I + R$ \\
$N_0$ & initial value of population size \\
\hline \end{tabular} \end{table}

Before demonstrating the statistical analysis functions of spearo, we
provide an overview of the simulation functions. These functions
essentially provide a convenient interface to the general simulation
capabilities of the pomp package. The user calls the
create_simulator() function to create an object of class pomp. This
object contains the model structure as well as default parameters for
the simulation. Simulations of the model may then be run using the
simulate method in the pomp package:
```{r}
library(spaero)
sim <- create_simulator()
simout <- pomp::simulate(sim)
```

This code creates a new pomp object and runs a simulation with the
default parameters. The variable simout contains a second pomp object
that contains the simulation results. These results may be extracted
like so:
```{r}
as(simout, "data.frame")
```

Alternatively, one can run the simulator like this to output the
results as a data frame.
```[r]
simout <- pomp::simulate(sim, as.data.frame=TRUE)
```

In addition to simulating the dynamics of disease spread, the pomp
object also simulates imperfect observation of the dynamics. A cases
variable is included in the output and it counts the total number of
recoveries that occured in the preceding interval between
observations. A corresponding number of reports is simulated by
sampling from a binomial probability mass function with a number of
trials equal to the number of cases and a reporting probability equal
to a user-supplied parameter, $\rho$.

Observation times and parameters can be set at simulation run time:
```{r}
pars <- sim@params
pars["rho"] <- 0.5
pomp::simulate(sim, params=pars, times=seq(1, 4), as.data.frame=TRUE)
```
However, the covariate table that determines the time dependence of
rates cannot be set at simulation time.

One can also set the number of replicates.
```{r}
pomp::simulate(sim, nsim=2, times=seq(1, 2), as.data.frame=TRUE)
```

The random number seed allows simulations to be reproduced.
```{r}
pomp::simulate(sim, seed=342, as.data.frame=TRUE)
pomp::simulate(sim, seed=342, as.data.frame=TRUE)
```

An SIS model is also available. This model is identical to the SIR
model except that the recovery event in Table~\ref{trules} results in an
infective individual becoming a susceptible.
```{r}
sim_sis <- create_simulator(process_model="SIS")
pomp::simulate(sim_sis, as.data.frame=TRUE)
```

Now let's simulate data according to the SIR model where the
transmission rate starts out well below the treshold value and
gradually increases.
```{r}

params <- c(gamma=24, mu=0.014, d=0.014, eta=1e-4, beta=1.9e-5,
            rho=0.5, S_0=1, I_0=0, R_0=0, N_0=1e5)
covar <- data.frame(gamma_t=c(0, 0), mu_t=c(0, 0), d_t=c(0, 0), eta_t=c(0, 0),
                    beta_t=c(0, 24e-5 - 1.9e-5), time=c(0, 300))
times <- seq(0, 200, by=0.25)

sim <- create_simulator(params=params, times=times, covar=covar)
so <- pomp::simulate(sim, as.data.frame=TRUE)
plot(ts(so[, "reports"], freq=4), ylab="No. reports")

```

By eye, we can see the distribution of reports seems to change over
time. We can summarize these changes by computing statistics over
moving windows.

```{r}

st <- get_stats(so[, "reports"], center_kernel="uniform",
                center_trend="local_constant", center_bandwidth=40, stat_bandwidth=40)
plot_vars <- ts(cbind(reports=so[, "reports"], mean=st$stats$mean,
                      autocorrelation=st$stats$auto, variance=st$stats$var,
                      skewness=st$stats$skew, kurtosis=st$stats$kurt), freq=4)
plot(plot_vars, main="")

```


\begin{center}
\textsc{To be continued \ldots}
\end{center}


## References
